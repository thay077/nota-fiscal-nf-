<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PALMAS AUTO PEÇAS - NOTA FISCAL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5faff;
      margin: 0;
      color: #003366;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1 {
      background-color: #007acc;
      color: white;
      margin: 0;
      padding: 20px 0;
      text-align: center;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .container {
      flex-grow: 1;
      max-width: 900px;
      margin: 25px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 122, 204, 0.2);
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    input[type=text], input[type=number], select, input[type=password] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1.8px solid #7db9e8;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type=text]:focus, input[type=number]:focus, select:focus, input[type=password]:focus {
      outline: none;
      border-color: #005f99;
      box-shadow: 0 0 8px #4ca3ddaa;
    }
    button {
      background-color: #007acc;
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 18px;
      transition: background-color 0.3s ease;
      box-shadow: 0 3px 7px rgba(0,122,204,0.4);
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #005f99;
    }
    button:disabled {
      background-color: #a3c7ff;
      cursor: default;
      box-shadow: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 0.9rem;
      user-select: none;
    }
    th, td {
      border: 1.6px solid #a8cdfd;
      padding: 10px 12px;
      text-align: left;
    }
    th {
      background-color: #d0e5ff;
      font-weight: 700;
      color: #003366;
    }
    td button {
      background-color: #cc3300;
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 4px;
      box-shadow: none;
      user-select: none;
    }
    td button:hover {
      background-color: #a02700;
    }
    .hidden {
      display: none !important;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .btn-group button {
      min-width: 160px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      box-shadow: 0 3px 7px rgba(0, 122, 204, 0.5);
    }
    #notaEmitida {
      margin-top: 25px;
      padding: 20px;
      border-radius: 10px;
      border: 1.5px solid #7db9e8;
      background: #e8f2ff;
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      font-size: 0.9rem;
      color: #004080;
      user-select: text;
      min-height: 240px;
    }
    #btnDownloadPdf {
      margin-top: 15px;
    }
    /* Feedback mensagem */
    #msgFeedback {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #007accdd;
      color: white;
      padding: 12px 22px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(0,122,204,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      user-select: none;
      z-index: 9999;
    }
    #msgFeedback.show {
      opacity: 1;
      pointer-events: auto;
    }
    /* Rodapé */
    footer {
      text-align: center;
      font-size: 0.85rem;
      color: #005f99;
      padding: 12px 0;
      background: #d0e5ff;
      user-select: none;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
  </style>
</head>
<body>

  <h1>PALMAS AUTO PEÇAS - NOTA FISCAL</h1>

  <div class="container" id="loginContainer">
    <h2>Login</h2>
    <label for="usuario">Usuário:</label>
    <input type="text" id="usuario" placeholder="Digite seu usuário" autocomplete="username" />
    <label for="senha">Senha:</label>
    <input type="password" id="senha" placeholder="Digite sua senha" autocomplete="current-password" />
    <button onclick="login()">Entrar</button>
  </div>

  <div class="container hidden" id="mainContainer">

    <div class="btn-group">
      <button onclick="mostrarTela('produtosContainer')">Cadastrar Produtos</button>
      <button onclick="mostrarTela('clientesContainer')">Cadastrar Clientes</button>
      <button onclick="mostrarTela('notaContainer')">Emitir Nota Fiscal</button>
    </div>

    <!-- Cadastro Produtos -->
    <section id="produtosContainer" class="hidden" aria-label="Cadastro de Produtos">
      <h2>Cadastro de Produtos</h2>
      <label for="codigoProduto">Código (2 dígitos):</label>
      <input type="text" id="codigoProduto" maxlength="2" placeholder="Ex: 01" aria-describedby="codigoHelp" />
      <label for="nomeProduto">Nome do Produto:</label>
      <input type="text" id="nomeProduto" placeholder="Ex: Filtro de Óleo" />
      <label for="valorProduto">Valor (R$):</label>
      <input type="number" step="0.01" min="0" id="valorProduto" placeholder="Ex: 99.90" />
      <button id="btnAddProduto" onclick="adicionarProduto()">Adicionar Produto</button>

      <table id="tabelaProdutos" aria-live="polite" aria-label="Lista de Produtos cadastrados">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nome</th>
            <th>Valor (R$)</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody>
          <!-- Produtos adicionados aparecerão aqui -->
        </tbody>
      </table>
    </section>

    <!-- Cadastro Clientes -->
    <section id="clientesContainer" class="hidden" aria-label="Cadastro de Clientes">
      <h2>Cadastro de Clientes</h2>
      <label for="nomeClienteCadastro">Nome do Cliente:</label>
      <input type="text" id="nomeClienteCadastro" placeholder="Nome completo" />
      <label for="cpfCnpjClienteCadastro">CPF/CNPJ:</label>
      <input type="text" id="cpfCnpjClienteCadastro" placeholder="CPF ou CNPJ" />
      <label for="enderecoClienteCadastro">Endereço:</label>
      <input type="text" id="enderecoClienteCadastro" placeholder="Endereço do cliente" />
      <button id="btnAddCliente" onclick="adicionarCliente()">Adicionar Cliente</button>

      <table id="tabelaClientes" aria-live="polite" aria-label="Lista de Clientes cadastrados">
        <thead>
          <tr>
            <th>Nome</th>
            <th>CPF/CNPJ</th>
            <th>Endereço</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody>
          <!-- Clientes adicionados aparecerão aqui -->
        </tbody>
      </table>
    </section>

    <!-- Emitir Nota Fiscal -->
    <section id="notaContainer" class="hidden" aria-label="Emitir Nota Fiscal">
      <h2>Emitir Nota Fiscal</h2>

      <label for="selectClienteNota">Cliente:</label>
      <select id="selectClienteNota" aria-required="true">
        <option value="">-- Selecione um cliente --</option>
      </select>

      <label for="selecionarProdutoNota">Produto:</label>
      <select id="selecionarProdutoNota" aria-required="true">
        <option value="">-- Selecione um produto --</option>
      </select>

      <label for="quantidadeNota">Quantidade:</label>
      <input type="number" id="quantidadeNota" min="1" value="1" />

      <button id="btnAddItemNota" onclick="adicionarItemNota()">Adicionar à Nota</button>

      <table id="tabelaNota" aria-live="polite" aria-label="Itens da Nota Fiscal">
        <thead>
          <tr>
            <th>Código</th>
            <th>Produto</th>
            <th style="text-align:right;">Valor Unitário (R$)</th>
            <th style="text-align:center;">Quantidade</th>
            <th style="text-align:right;">Subtotal (R$)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Itens da nota aparecem aqui -->
        </tbody>
      </table>

      <button id="btnEmitirNota" onclick="emitirNota()" disabled>Emitir Nota Fiscal</button>

      <pre id="notaEmitida" class="hidden" aria-live="polite" aria-label="Nota Fiscal emitida"></pre>
      <button id="btnDownloadPdf" class="hidden" onclick="baixarPDF()">Baixar Nota Fiscal em PDF</button>
    </section>

  </div>

  <div id="msgFeedback"></div>

  <footer>
    &copy; 2025 Palmas Auto Peças. Todos os direitos reservados.
  </footer>

  <script>
    let produtos = [];
    let clientes = [];
    let itensNota = [];

    const msgFeedback = document.getElementById('msgFeedback');

    // Exibe mensagens temporárias de feedback
    function mostrarMensagem(texto, sucesso = true) {
      msgFeedback.textContent = texto;
      msgFeedback.style.backgroundColor = sucesso ? '#007accdd' : '#cc3300dd';
      msgFeedback.classList.add('show');
      setTimeout(() => msgFeedback.classList.remove('show'), 3500);
    }

    function login() {
      const usuario = document.getElementById('usuario').value.trim();
      const senha = document.getElementById('senha').value.trim();

      if(usuario === '' || senha === '') {
        mostrarMensagem('Preencha usuário e senha.', false);
        return;
      }
      // Aqui poderia validar contra um backend; aceita qualquer login
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('mainContainer').classList.remove('hidden');
      mostrarTela('produtosContainer');
      carregarProdutosNoSelect();
      carregarClientesNoSelect();
      mostrarMensagem('Login efetuado com sucesso!');
    }

    function mostrarTela(id) {
      const telas = ['produtosContainer', 'clientesContainer', 'notaContainer'];
      telas.forEach(tela => {
        document.getElementById(tela).classList.toggle('hidden', tela !== id);
      });
      // Reset mensagens da nota
      if(id !== 'notaContainer') {
        limparNota();
      }
    }

    // Produtos
    function adicionarProduto() {
      const codigo = document.getElementById('codigoProduto').value.trim();
      const nome = document.getElementById('nomeProduto').value.trim();
      const valor = parseFloat(document.getElementById('valorProduto').value);

      if(codigo.length !== 2 || !/^\d{2}$/.test(codigo)) {
        mostrarMensagem('Código deve ter exatamente 2 dígitos numéricos.', false);
        return;
      }
      if(nome === '') {
        mostrarMensagem('Nome do produto não pode estar vazio.', false);
        return;
      }
      if(isNaN(valor) || valor <= 0) {
        mostrarMensagem('Valor deve ser um número positivo.', false);
        return;
      }
      if(produtos.find(p => p.codigo === codigo)) {
        mostrarMensagem('Código já cadastrado.', false);
        return;
      }

      produtos.push({codigo, nome, valor});
      limparCamposProduto();
      atualizarTabelaProdutos();
      carregarProdutosNoSelect();
      mostrarMensagem('Produto adicionado com sucesso!');
    }

    function limparCamposProduto() {
      document.getElementById('codigoProduto').value = '';
      document.getElementById('nomeProduto').value = '';
      document.getElementById('valorProduto').value = '';
      document.getElementById('codigoProduto').focus();
    }

    function atualizarTabelaProdutos() {
      const tbody = document.querySelector('#tabelaProdutos tbody');
      tbody.innerHTML = '';
      produtos.forEach(prod => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${prod.codigo}</td>
          <td>${prod.nome}</td>
          <td>${prod.valor.toFixed(2).replace('.',',')}</td>
          <td><button title="Excluir produto ${prod.nome}" aria-label="Excluir produto ${prod.nome}" onclick="excluirProduto('${prod.codigo}')">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function excluirProduto(codigo) {
      if(confirm('Tem certeza que deseja excluir o produto?')) {
        produtos = produtos.filter(p => p.codigo !== codigo);
        atualizarTabelaProdutos();
        carregarProdutosNoSelect();
        mostrarMensagem('Produto excluído.');
      }
    }

    function carregarProdutosNoSelect() {
      const select = document.getElementById('selecionarProdutoNota');
      select.innerHTML = '<option value="">-- Selecione um produto --</option>';
      produtos.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod.codigo;
        option.textContent = `${prod.codigo} - ${prod.nome}`;
        select.appendChild(option);
      });
      habilitarBotaoAdicionarItemNota();
    }

    // Clientes
    function adicionarCliente() {
      const nome = document.getElementById('nomeClienteCadastro').value.trim();
      const cpfcnpj = document.getElementById('cpfCnpjClienteCadastro').value.trim();
      const endereco = document.getElementById('enderecoClienteCadastro').value.trim();

      if(nome.length < 3) {
        mostrarMensagem('Nome do cliente deve ter pelo menos 3 caracteres.', false);
        return;
      }
      if(cpfcnpj.length < 11) {
        mostrarMensagem('CPF/CNPJ inválido.', false);
        return;
      }
      if(endereco.length < 5) {
        mostrarMensagem('Endereço muito curto.', false);
        return;
      }

      clientes.push({nome, cpfcnpj, endereco});
      limparCamposCliente();
      atualizarTabelaClientes();
      carregarClientesNoSelect();
      mostrarMensagem('Cliente adicionado com sucesso!');
    }

    function limparCamposCliente() {
      document.getElementById('nomeClienteCadastro').value = '';
      document.getElementById('cpfCnpjClienteCadastro').value = '';
      document.getElementById('enderecoClienteCadastro').value = '';
      document.getElementById('nomeClienteCadastro').focus();
    }

    function atualizarTabelaClientes() {
      const tbody = document.querySelector('#tabelaClientes tbody');
      tbody.innerHTML = '';
      clientes.forEach((cli, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cli.nome}</td>
          <td>${cli.cpfcnpj}</td>
          <td>${cli.endereco}</td>
          <td><button title="Excluir cliente ${cli.nome}" aria-label="Excluir cliente ${cli.nome}" onclick="excluirCliente(${index})">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function excluirCliente(index) {
      if(confirm('Tem certeza que deseja excluir o cliente?')) {
        clientes.splice(index, 1);
        atualizarTabelaClientes();
        carregarClientesNoSelect();
        mostrarMensagem('Cliente excluído.');
      }
    }

    function carregarClientesNoSelect() {
      const select = document.getElementById('selectClienteNota');
      select.innerHTML = '<option value="">-- Selecione um cliente --</option>';
      clientes.forEach((cli, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${cli.nome} (${cli.cpfcnpj})`;
        select.appendChild(option);
      });
      habilitarBotaoEmitirNota();
    }

    // Nota Fiscal
    function adicionarItemNota() {
      const codigoProduto = document.getElementById('selecionarProdutoNota').value;
      const quantidade = parseInt(document.getElementById('quantidadeNota').value, 10);

      if(codigoProduto === '') {
        mostrarMensagem('Selecione um produto para adicionar.', false);
        return;
      }
      if(isNaN(quantidade) || quantidade < 1) {
        mostrarMensagem('Quantidade deve ser um número inteiro positivo.', false);
        return;
      }

      const produto = produtos.find(p => p.codigo === codigoProduto);
      if(!produto) {
        mostrarMensagem('Produto não encontrado.', false);
        return;
      }

      // Se produto já estiver na nota, soma quantidade
      const itemExistente = itensNota.find(item => item.codigo === codigoProduto);
      if(itemExistente) {
        itemExistente.quantidade += quantidade;
      } else {
        itensNota.push({codigo: produto.codigo, nome: produto.nome, valor: produto.valor, quantidade});
      }

      atualizarTabelaNota();
      limparCamposItemNota();
      habilitarBotaoEmitirNota();
      mostrarMensagem('Item adicionado à nota.');
    }

    function atualizarTabelaNota() {
      const tbody = document.querySelector('#tabelaNota tbody');
      tbody.innerHTML = '';

      itensNota.forEach(item => {
        const tr = document.createElement('tr');
        const subtotal = item.valor * item.quantidade;
        tr.innerHTML = `
          <td>${item.codigo}</td>
          <td>${item.nome}</td>
          <td style="text-align:right;">${item.valor.toFixed(2).replace('.',',')}</td>
          <td style="text-align:center;">${item.quantidade}</td>
          <td style="text-align:right;">${subtotal.toFixed(2).replace('.',',')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function limparCamposItemNota() {
      document.getElementById('selecionarProdutoNota').value = '';
      document.getElementById('quantidadeNota').value = 1;
      document.getElementById('selecionarProdutoNota').focus();
    }

    function habilitarBotaoEmitirNota() {
      const clienteSelecionado = document.getElementById('selectClienteNota').value;
      const btn = document.getElementById('btnEmitirNota');
      btn.disabled = !(clienteSelecionado !== '' && itensNota.length > 0);
    }
    function habilitarBotaoAdicionarItemNota() {
      const produtosDisponiveis = produtos.length > 0;
      document.getElementById('btnAddItemNota').disabled = !produtosDisponiveis;
    }

    // Quando cliente mudar, habilita ou desabilita botão emitir nota
    document.getElementById('selectClienteNota').addEventListener('change', habilitarBotaoEmitirNota);

    function emitirNota() {
      if(itensNota.length === 0) {
        mostrarMensagem('Adicione pelo menos um item para emitir nota.', false);
        return;
      }

      const clienteIndex = parseInt(document.getElementById('selectClienteNota').value, 10);
      if(isNaN(clienteIndex) || !clientes[clienteIndex]) {
        mostrarMensagem('Selecione um cliente válido.', false);
        return;
      }

      const cliente = clientes[clienteIndex];
      let total = 0;
      let textoNota = '';
      textoNota += 'PALMAS AUTO PEÇAS - NOTA FISCAL\n\n';
      textoNota += `Cliente: ${cliente.nome}\nCPF/CNPJ: ${cliente.cpfcnpj}\nEndereço: ${cliente.endereco}\n\n`;
      textoNota += 'Itens:\n';
      textoNota += 'Código | Produto                | Valor Unit. | Qtde | Subtotal\n';
      textoNota += '--------------------------------------------------------------\n';

      itensNota.forEach(item => {
        const subtotal = item.valor * item.quantidade;
        total += subtotal;
        textoNota += `${item.codigo.padEnd(6)} | ${item.nome.padEnd(22)} | R$ ${item.valor.toFixed(2).padStart(8).replace('.',',')} | ${item.quantidade.toString().padStart(4)} | R$ ${subtotal.toFixed(2).padStart(8).replace('.',',')}\n`;
      });
      textoNota += '--------------------------------------------------------------\n';
      textoNota += `Total: R$ ${total.toFixed(2).replace('.',',')}\n`;
      textoNota += '\nObrigado pela preferência!';

      const preNota = document.getElementById('notaEmitida');
      preNota.textContent = textoNota;
      preNota.classList.remove('hidden');

      document.getElementById('btnDownloadPdf').classList.remove('hidden');

      mostrarMensagem('Nota fiscal emitida com sucesso!');
    }

    function limparNota() {
      itensNota = [];
      atualizarTabelaNota();
      document.getElementById('notaEmitida').classList.add('hidden');
      document.getElementById('btnDownloadPdf').classList.add('hidden');
      habilitarBotaoEmitirNota();
    }

    // Gerar PDF da nota
    async function baixarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const texto = document.getElementById('notaEmitida').textContent;

      const lines = doc.splitTextToSize(texto, 180);
      doc.setFont("Courier", "normal");
      doc.setFontSize(12);
      doc.text(lines, 10, 10);

      doc.save("Nota_Fiscal_Palmas_AutoPecas.pdf");
    }
  </script>

</body>
</html>
